{"version":3,"file":"proxyRequest.js","names":["log","Logger","child","namespace","defaultChromeHeaders","accept","appendDefaultChromeHeaders","request","nextHeaders","headers","host","URL","url","hostname","isNavigationRequest","proxyRequest","proxyRequestConfiguration","page","proxyUrl","startsWith","continue","debug","body","postData","method","console","puppeteerCookies","getAllCookies","cookies","cookieJar","CookieJar","deserializeSync","map","puppeteerCookie","formatPuppeteerCookieAsToughCookie","rejectPublicSuffixes","storeType","version","getCookieString","promisify","bind","setCookie","gotCookieJar","rawCookie","ignoreError","agent","http","HttpProxyAgent","https","HttpsProxyAgent","response","got","followRedirect","responseType","retry","throwHttpErrors","error","serializeError","abort","Error","consoe","respond","status","statusCode"],"sources":["../../src/routines/proxyRequest.js"],"sourcesContent":["// @flow\n\nimport {\n  promisify,\n} from 'util';\nimport type {\n  Request,\n} from 'puppeteer';\nimport got from 'got';\nimport {\n  CookieJar,\n} from 'tough-cookie';\nimport {\n  serializeError,\n} from 'serialize-error';\nimport HttpProxyAgent from 'http-proxy-agent';\nimport HttpsProxyAgent from 'https-proxy-agent';\nimport {\n  formatPuppeteerCookieAsToughCookie,\n} from '../utilities';\nimport type {\n  ProxyRequestConfigurationType,\n} from '../types';\nimport Logger from '../Logger';\nimport getAllCookies from './getAllCookies';\n\nconst log = Logger.child({\n  namespace: 'proxyRequest',\n});\n\nconst defaultChromeHeaders = {\n  accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',\n  'accept-encoding': 'gzip, deflate, br',\n  'accept-language': 'en',\n};\n\n/**\n * @see https://github.com/puppeteer/puppeteer/issues/5364\n */\nconst appendDefaultChromeHeaders = (request: Request) => {\n  let nextHeaders = {\n    ...request.headers(),\n    ...defaultChromeHeaders,\n    host: new URL(request.url()).hostname,\n  };\n\n  if (request.isNavigationRequest()) {\n    nextHeaders = {\n      ...nextHeaders,\n      'sec-fetch-mode': 'navigate',\n      'sec-fetch-site': 'none',\n      'sec-fetch-user': '?1',\n    };\n  } else {\n    nextHeaders = {\n      ...nextHeaders,\n      'sec-fetch-mode': 'no-cors',\n      'sec-fetch-site': 'same-origin',\n    };\n  }\n\n  return nextHeaders;\n};\n\nconst proxyRequest = async (proxyRequestConfiguration: ProxyRequestConfigurationType): Promise<void> => {\n  const {\n    page,\n    proxyUrl,\n    request,\n  } = proxyRequestConfiguration;\n\n  // e.g. data URI scheme\n  if (!request.url().startsWith('http://') && !request.url().startsWith('https://')) {\n    request.continue();\n\n    return;\n  }\n\n  const headers = appendDefaultChromeHeaders(request);\n  log.debug({\n    body: request.postData(),\n    headers,\n    method: request.method(),\n    url: request.url(),\n  }, 'making a request using HTTP proxy');\n\n  console.log(\"getting cookies\");\n  const puppeteerCookies = (await getAllCookies(page)).cookies;\n\n  const cookieJar = CookieJar.deserializeSync({\n    cookies: puppeteerCookies.map((puppeteerCookie) => {\n      return formatPuppeteerCookieAsToughCookie(puppeteerCookie);\n    }),\n    rejectPublicSuffixes: true,\n    storeType: 'MemoryCookieStore',\n    version: 'tough-cookie@2.0.0',\n  });\n\n  const getCookieString = promisify(cookieJar.getCookieString.bind(cookieJar));\n  const setCookie = promisify(cookieJar.setCookie.bind(cookieJar));\n\n  const gotCookieJar = {\n    getCookieString: (url) => {\n      return getCookieString(url);\n    },\n    setCookie: (rawCookie: string, url: string) => {\n      return setCookie(\n        rawCookie,\n        url,\n        {\n          ignoreError: true,\n        },\n      );\n    },\n  };\n\n  let agent;\n\n  if (proxyRequestConfiguration.agent) {\n    agent = proxyRequestConfiguration.agent;\n  } else if (proxyUrl) {\n    agent = {\n      http: new HttpProxyAgent(proxyUrl.http || proxyUrl),\n      https: new HttpsProxyAgent(proxyUrl.https || proxyUrl),\n    };\n  }\n\n  let response;\n\n  try {\n    console.log(\"making request\");\n    response = await got(request.url(), {\n      agent,\n      body: request.postData(),\n      cookieJar: gotCookieJar,\n      followRedirect: false,\n      headers,\n      method: request.method(),\n      responseType: 'buffer',\n      retry: 0,\n      throwHttpErrors: false,\n    });\n  } catch (error) {\n    console.log(\"GOT damnit\", error);\n    log.error({\n      error: serializeError(error),\n    }, 'could not complete HTTP request due to an error');\n\n    request.abort();\n\n    return;\n  }\n\n  if (!response) {\n    throw new Error('response object is not present.');\n  }\n\n  consoe.log(\"responding\");\n  await request.respond({\n    body: response.body,\n    headers: response.headers,\n    status: response.statusCode,\n  });\n};\n\nexport default async (proxyRequestConfiguration: ProxyRequestConfigurationType) => {\n  try {\n    await proxyRequest(proxyRequestConfiguration);\n  } catch (error) {\n    console.log(\"config error\", error);\n    log.error({\n      error: serializeError(error),\n    }, 'could not proxy request due to an error');\n\n    proxyRequestConfiguration.request.abort();\n  }\n};\n"],"mappings":"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"}